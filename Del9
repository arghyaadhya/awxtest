#!/bin/bash

# Input file
input_file="input.txt"

# Output file
output_file="output.txt"

# Hostname to match
hostname="your_hostname"

awk -v host="$hostname" '
{
    # Store the current line with its line number
    lines[NR] = $0;
}

{
    # Mark where we start deleting if a block starts
    if ($0 == "Begin limit") {
        in_block = 1;
        delete_start = NR;
        block_content = "";
        return;
    }

    if ($0 == "End limit" && in_block) {
        in_block = 0;
        delete_end = NR;

        # Check the block content between Begin limit and End limit
        block_contains_only_hostname = 1;
        block_contains_hostname = 0;

        for (i = delete_start + 1; i < delete_end; i++) {
            if (lines[i] ~ host) {
                block_contains_hostname = 1;
            }
            if (lines[i] !~ host && lines[i] !~ /^[[:space:]]*$/) {
                block_contains_only_hostname = 0;
            }
        }

        # If the block only contains the hostname, delete the whole block
        if (block_contains_only_hostname) {
            for (i = delete_start; i <= delete_end; i++) {
                delete_flag[i] = 1;
            }
        } 
        # If the block contains other hostnames, delete only the matched lines
        else if (block_contains_hostname) {
            for (i = delete_start + 1; i < delete_end; i++) {
                if (lines[i] ~ host) {
                    delete_flag[i] = 1;
                }
            }
        }

        # Skip to continue processing after End limit
        return;
    }

    # Collect block content while inside a block
    if (in_block) {
        block_content = block_content $0 "\n";
    }
}

END {
    # Output lines that are NOT in the deletion range
    for (i = 1; i <= NR; i++) {
        if (!delete_flag[i]) {
            print lines[i];
        }
    }
}
' "$input_file" > "$output_file"

echo "Processed file saved to $output_file."
