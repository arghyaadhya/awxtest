#!/bin/bash

# Usage: ./script.sh <file> <hostname_to_match>
# Example: ./script.sh config.txt test-1234-001.static.test.com

CONFIG_FILE="$1"
HOSTNAME="$2"

# Validate input
if [[ -z "$CONFIG_FILE" || -z "$HOSTNAME" ]]; then
  echo "Usage: $0 <file> <hostname_to_match>"
  exit 1
fi

if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "Error: Config file '$CONFIG_FILE' does not exist."
  exit 1
fi

# Backup the original file
cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"

awk -v host="$HOSTNAME" '
  BEGIN {
    block_active = 0;  # Flag to track if we are inside a block
    delete_block = 0;  # Flag to delete block if needed
    output_block = ""; # Store content of current block
  }

  # Detect the start of a block (Begin Limit)
  /^Begin[[:space:]]*Limit/ {
    block_active = 1;
    delete_block = 0;
    output_block = $0 "\n";  # Start by storing the Begin Limit line
    next;
  }

  # Inside the block, process each line
  block_active {
    output_block = output_block $0 "\n";  # Add current line to block content

    # If the line starts with "HOST=", process it
    if ($1 ~ /^HOST=/) {
      hosts_line = substr($0, index($0, "=") + 1);  # Get the hosts after the '='
      split(hosts_line, hosts, " ");  # Split into individual hostnames
      remaining_hosts = "";  # To store the remaining hosts after matching
      found_host = 0;

      # Loop through hosts and check if the target host is present
      for (i in hosts) {
        if (hosts[i] == host) {
          found_host = 1;
        } else {
          remaining_hosts = remaining_hosts (remaining_hosts == "" ? "" : " ") hosts[i];
        }
      }

      # Case: Host matches and there are no remaining hosts, mark the block for deletion
      if (found_host && length(remaining_hosts) == 0) {
        delete_block = 1;
      }

      # Otherwise, update the HOST= line with remaining hosts
      if (found_host && length(remaining_hosts) > 0) {
        gsub(/HOST=.*/, "HOST=" remaining_hosts);  # Replace old HOST line with remaining hosts
        output_block = $0 "\n";  # Store updated line
      }
    }
    next;
  }

  # End of the block (End Limit)
  /^End[[:space:]]*Limit/ {
    if (block_active && !delete_block) {
      output_block = output_block $0 "\n";  # Add the End Limit line to the block
      print output_block;  # Output the block if it wasn't marked for deletion
    }
    block_active = 0;  # Reset block state for the next block
    output_block = ""; # Clear current block content
    next;
  }

  # Lines outside blocks
  !block_active {
    print $0;
  }
' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

echo "Processing completed. Backup saved as ${CONFIG_FILE}.bak."
