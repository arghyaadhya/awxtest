#!/bin/bash

# Input and output files
input_file="input.txt"
output_file="output.txt"

# Hostname to match
hostname="your_hostname"

# Temporary variables
in_block=false
block_lines=()      # Array to store block content

# Function to process a block
process_block() {
    block_only_hostname=true
    has_hostname=false

    # Check content of the block
    for line in "${block_lines[@]}"; do
        if [[ $line =~ $hostname ]]; then
            has_hostname=true
        fi
        if [[ $line != "$hostname" && $line != "Begin limit" && $line != "End limit" && -n $line ]]; then
            block_only_hostname=false
        fi
    done

    # Decide how to handle the block
    if $block_only_hostname && $has_hostname; then
        # Delete the block (do not print)
        return
    fi
    if $has_hostname; then
        # Print the block excluding matched hostname lines
        for line in "${block_lines[@]}"; do
            [[ $line =~ $hostname ]] && continue
            echo "$line"
        done
    else
        # Print the block as-is
        for line in "${block_lines[@]}"; do
            echo "$line"
        done
    fi
}

# Main loop to read input file
while IFS= read -r line || [[ -n $line ]]; do
    if [[ $line == "Begin limit" ]]; then
        in_block=true
        block_lines=("$line") # Start a new block
    elif [[ $line == "End limit" ]]; then
        in_block=false
        block_lines+=("$line") # End the block
        process_block           # Process the block
        block_lines=()          # Reset the block array
    elif $in_block; then
        block_lines+=("$line")  # Add line to the block
    else
        # Print non-block lines
        echo "$line"
    fi
done < "$input_file" > "$output_file"

echo "Processed file saved to $output_file."
