#!/usr/bin/env bash
set -euo pipefail

# === Configuration ===
HOSTFILE="hosts.txt"              # one host per line
USER="root"                       # ssh user (can be non-root if you adjust commands)
PASS="YourPassword"               # ssh password (consider using SSH keys instead)
NFS_PATH="/mnt/nfs/uberagent"     # local path where installer + conf exist
REMOTE_TMP="/tmp/uberagent_install"
CONF_PATH="/etc/uberAgent"
LOG="uberagent_install.log"
DEB_NAME="uberAgent_linux.deb"
RPM_NAME="uberAgent_linux.rpm"
CONF_NAME="uberAgent.conf"
SERVICE_NAME="uberAgent.service"  # per your choice (option 1)

# === Start ===
echo "===== uberAgent Installation Started: $(date -u) =====" | tee -a "$LOG"

# basic pre-checks
if [[ ! -f "$NFS_PATH/$CONF_NAME" ]]; then
  echo "ERROR: Config missing at $NFS_PATH/$CONF_NAME" | tee -a "$LOG"
  exit 1
fi

if [[ ! -f "$NFS_PATH/$DEB_NAME" && ! -f "$NFS_PATH/$RPM_NAME" ]]; then
  echo "ERROR: No installer found. Place $DEB_NAME and/or $RPM_NAME in $NFS_PATH" | tee -a "$LOG"
  exit 1
fi

while IFS= read -r host || [[ -n "$host" ]]; do
    host=$(echo "$host" | xargs)   # trim
    [[ -z "$host" ]] && continue

    echo "---- Processing $host ----" | tee -a "$LOG"

    # create remote temp dir
    if ! sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no "$USER@$host" "mkdir -p '$REMOTE_TMP'"; then
        echo "❌ $host: cannot create remote tmp dir, skipping" | tee -a "$LOG"
        continue
    fi

    # detect OS (remote)
    OS_TYPE=$(sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no "$USER@$host" "awk -F= '/^ID=/{gsub(/\"/,\"\",\$2); print \$2; exit}' /etc/os-release" 2>/dev/null || true)
    OS_TYPE=${OS_TYPE,,}
    echo "$host OS detected: ${OS_TYPE:-unknown}" | tee -a "$LOG"

    # choose installer file based on OS
    if [[ "$OS_TYPE" == "debian" || "$OS_TYPE" == "ubuntu" ]]; then
        if [[ ! -f "$NFS_PATH/$DEB_NAME" ]]; then
            echo "❌ $host: missing local deb $NFS_PATH/$DEB_NAME" | tee -a "$LOG"
            continue
        fi
        INSTALLER_LOCAL="$NFS_PATH/$DEB_NAME"
        INSTALLER_REMOTE="$REMOTE_TMP/$DEB_NAME"
        PKG_TYPE="deb"
    else
        # treat unknown as rpm-based fallback (rhel/centos/alma/rocky/ol/fedora)
        if [[ ! -f "$NFS_PATH/$RPM_NAME" ]]; then
            echo "❌ $host: missing local rpm $NFS_PATH/$RPM_NAME" | tee -a "$LOG"
            continue
        fi
        INSTALLER_LOCAL="$NFS_PATH/$RPM_NAME"
        INSTALLER_REMOTE="$REMOTE_TMP/$RPM_NAME"
        PKG_TYPE="rpm"
    fi

    # copy installer + conf in single scp
    echo "$host: copying installer + config to $REMOTE_TMP" | tee -a "$LOG"
    if ! sshpass -p "$PASS" scp -o StrictHostKeyChecking=no "$INSTALLER_LOCAL" "$NFS_PATH/$CONF_NAME" "$USER@$host:$REMOTE_TMP/"; then
        echo "❌ $host: scp failed" | tee -a "$LOG"
        continue
    fi

    # install package & replace config & enable/start service (single ssh session)
    echo "$host: installing package, updating config, enabling+starting $SERVICE_NAME" | tee -a "$LOG"
    sshpass -p "$PASS" ssh -o StrictHostKeyChecking=no "$USER@$host" bash -s <<'REMOTE' 2>&1 | tee -a "$LOG"
set -e
REMOTE_TMP="/tmp/uberagent_install"
CONF_PATH="/etc/uberAgent"
CONF_NAME="uberAgent.conf"
SERVICE_NAME="uberAgent.service"

# Determine which installer exists in REMOTE_TMP
if [[ -f "$REMOTE_TMP/uberAgent_linux.deb" ]]; then
  echo "Installing deb package..."
  dpkg -i "$REMOTE_TMP/uberAgent_linux.deb" || (apt-get update -y && apt-get install -f -y)
elif [[ -f "$REMOTE_TMP/uberAgent_linux.rpm" ]]; then
  echo "Installing rpm package..."
  if command -v dnf >/dev/null 2>&1; then
    dnf install -y "$REMOTE_TMP/uberAgent_linux.rpm"
  else
    yum install -y "$REMOTE_TMP/uberAgent_linux.rpm"
  fi
else
  echo "ERROR: No installer found in $REMOTE_TMP" >&2
  exit 2
fi

# Replace configuration (backup previous)
mkdir -p "$CONF_PATH"
if [[ -f "$CONF_PATH/$CONF_NAME" ]]; then
  cp -p "$CONF_PATH/$CONF_NAME" "$CONF_PATH/${CONF_NAME}.bak.$(date +%s)" || true
fi
cp -p "$REMOTE_TMP/$CONF_NAME" "$CONF_PATH/$CONF_NAME"
chown root:root "$CONF_PATH/$CONF_NAME" || true
chmod 0644 "$CONF_PATH/$CONF_NAME" || true

# Enable + start service (simple fixed commands)
systemctl daemon-reload || true
systemctl enable "$SERVICE_NAME" || true
systemctl start "$SERVICE_NAME" || true
systemctl status --no-pager "$SERVICE_NAME" --lines=10 || true

# cleanup
rm -rf "$REMOTE_TMP" || true
REMOTE
    echo "✔ $host: completed" | tee -a "$LOG"

done < "$HOSTFILE"

echo "===== uberAgent Installation Completed: $(date -u) =====" | tee -a "$LOG"
