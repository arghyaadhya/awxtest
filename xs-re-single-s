#!/bin/bash
# ---------------------------------------------------------------------
# Citrix XenServer / Hypervisor Pool Resource Summary (Final Version)
# ---------------------------------------------------------------------
# ✅ Works on all Citrix Hypervisor and XenServer versions
# ✅ Uses xe host-cpu-info --minimal for CPU counts
# ✅ Skips DVD and 0-size SRs
# ---------------------------------------------------------------------

if ! command -v xe &>/dev/null; then
  echo "Error: xe command not found. Run this on a XenServer host (preferably the pool master)."
  exit 1
fi

echo "============================================================"
echo " Citrix XenServer Pool Resource Summary"
echo "============================================================"
echo

total_cpu=0
total_mem=0

printf "%-25s %-10s %-15s\n" "HOST NAME" "CPU(CORES)" "MEMORY(GB)"
echo "------------------------------------------------------------"

hosts=$(xe host-list --minimal | tr ',' ' ')
if [[ -z "$hosts" ]]; then
  echo "No hosts found. Are you on the pool master?"
  exit 1
fi

for uuid in $hosts; do
  name=$(xe host-param-get uuid="$uuid" param-name=name-label)

  # ✅ Universal CPU count
  cpu=$(xe host-cpu-info host-uuid="$uuid" --minimal)

  # ✅ Memory
  mem_bytes=$(xe host-param-get uuid="$uuid" param-name=memory-total)
  mem_gb=$((mem_bytes/1024/1024/1024))

  printf "%-25s %-10s %-15s\n" "$name" "$cpu" "$mem_gb"

  total_cpu=$((total_cpu + cpu))
  total_mem=$((total_mem + mem_gb))
done

echo "------------------------------------------------------------"
printf "%-25s %-10s %-15s\n" "TOTAL" "$total_cpu" "$total_mem"
echo

echo "============================================================"
echo " Storage Repositories Summary (Excluding DVD & 0-size SRs)"
echo "============================================================"
printf "%-35s %-12s %-12s %-12s %-15s\n" "SR NAME" "TOTAL(GB)" "USED(GB)" "FREE(GB)" "TYPE"
echo "--------------------------------------------------------------------------"

# ✅ Loop through each SR
for sr_uuid in $(xe sr-list --minimal | tr ',' ' '); do
  sr_name=$(xe sr-param-get uuid="$sr_uuid" param-name=name-label)
  sr_total=$(xe sr-param-get uuid="$sr_uuid" param-name=physical-size)
  sr_used=$(xe sr-param-get uuid="$sr_uuid" param-name=physical-utilisation)
  sr_type=$(xe sr-param-get uuid="$sr_uuid" param-name=type)

  # Skip SRs that are ISO/DVD or have no size
  if [[ "$sr_type" == "iso" ]] || [[ "$sr_type" == "udev" ]] || [[ "$sr_total" -eq 0 ]]; then
    continue
  fi

  total_gb=$((sr_total/1024/1024/1024))
  used_gb=$((sr_used/1024/1024/1024))
  free_gb=$((total_gb - used_gb))

  printf "%-35s %-12s %-12s %-12s %-15s\n" "$sr_name" "$total_gb" "$used_gb" "$free_gb" "$sr_type"
done

echo "--------------------------------------------------------------------------"
echo " Summary completed successfully."
