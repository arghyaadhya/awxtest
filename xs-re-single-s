#!/bin/bash
# ---------------------------------------------------------------------
# Citrix XenServer Pool Resource Summary Script
# ---------------------------------------------------------------------
# Description: Summarizes total CPU, memory, and storage usage in a pool
# Author: Arghya Adhya
# ---------------------------------------------------------------------

# Ensure xe CLI is available
if ! command -v xe &>/dev/null; then
  echo "Error: xe command not found. Run this script on a XenServer host."
  exit 1
fi

echo "============================================================"
echo " Citrix XenServer Pool Resource Summary"
echo "============================================================"
echo

total_cpu=0
total_mem=0

printf "%-20s %-10s %-15s\n" "HOST NAME" "CPU(CORES)" "MEMORY(GB)"
echo "------------------------------------------------------------"

# Loop through each host in the pool
for uuid in $(xe host-list --minimal | tr ',' ' '); do
  name=$(xe host-param-get uuid=$uuid param-name=name-label)
  cpu=$(xe host-param-get uuid=$uuid param-name=cpu-info | grep -oP 'cpu_count: \K[0-9]+')
  mem_bytes=$(xe host-param-get uuid=$uuid param-name=memory-total)
  mem_gb=$(($mem_bytes/1024/1024/1024))
  
  printf "%-20s %-10s %-15s\n" "$name" "$cpu" "$mem_gb"
  
  total_cpu=$((total_cpu + cpu))
  total_mem=$((total_mem + mem_gb))
done

echo "------------------------------------------------------------"
printf "%-20s %-10s %-15s\n" "TOTAL" "$total_cpu" "$total_mem"
echo

echo "============================================================"
echo " Storage Repositories Summary"
echo "============================================================"
printf "%-25s %-15s %-15s %-15s\n" "SR NAME" "TOTAL(GB)" "USED(GB)" "FREE(GB)"
echo "------------------------------------------------------------"

# Loop through each SR (Storage Repository)
for sr_uuid in $(xe sr-list --minimal | tr ',' ' '); do
  sr_name=$(xe sr-param-get uuid=$sr_uuid param-name=name-label)
  sr_total=$(xe sr-param-get uuid=$sr_uuid param-name=physical-size)
  sr_used=$(xe sr-param-get uuid=$sr_uuid param-name=physical-utilisation)
  
  total_gb=$(($sr_total/1024/1024/1024))
  used_gb=$(($sr_used/1024/1024/1024))
  free_gb=$((total_gb - used_gb))
  
  printf "%-25s %-15s %-15s %-15s\n" "$sr_name" "$total_gb" "$used_gb" "$free_gb"
done

echo "------------------------------------------------------------"
echo " Summary completed successfully."
