#!/bin/bash

input="projects.txt"
output="project_group_roles.csv"

# Header for CSV
echo "ProjectKey,GroupName,Roles" > "$output"

while IFS= read -r project; do
  echo "Fetching group details for project: $project"

  response=$(curl -s -u "username:apitoken" \
       -X GET "https://your-jfrog-url/access/api/v1/projects/$project/groups")

  # If groups exist, print them; else write "NoGroups"
  echo "$response" | jq -r --arg project "$project" '
    if .groups then
      .groups[]? | [$project, .group_name, (.roles | join(";"))] | @csv
    else
      [$project, "NoGroups", "None"] | @csv
    end
  ' >> "$output"

done < "$input"

echo "âœ… Report saved to $output"
