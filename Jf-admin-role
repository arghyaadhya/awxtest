#!/bin/bash

input="projects.txt"
output="project_group_roles.csv"
token="YOUR_ACCESS_TOKEN"

echo "ProjectKey,GroupName,Role" > "$output"

while IFS= read -r project; do
  echo "Fetching group details for project: $project"

  response=$(curl -s -H "Authorization: Bearer $token" \
       -X GET "https://your-jfrog-url/access/api/v1/projects/$project/groups")

  # Try different JSON shapes safely
  echo "$response" | jq -r --arg project "$project" '
    if has("groups") then
      .groups[]? | [$project, (.name // .group_name), (.roles | join(";"))] | @csv
    elif has("roles") then
      .roles[]? | .groups[]? as $g | [$project, $g, .name] | @csv
    else
      [$project, "NoGroups", "None"] | @csv
    end
  ' >> "$output"

done < "$input"

echo "Report saved to $output"
