#!/bin/bash

# Usage: ./script.sh <file> <hostname_to_match>
# Example: ./script.sh config.txt test-1234-001.static.test.com

CONFIG_FILE="$1"
HOSTNAME="$2"

if [[ -z "$CONFIG_FILE" || -z "$HOSTNAME" ]]; then
  echo "Usage: $0 <file> <hostname_to_match>"
  exit 1
fi

# Backup the original file
cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"

awk -v host="$HOSTNAME" '
  BEGIN { block_active = 0; delete_block = 0; updated_block = ""; }

  # Start of a block
  /^Begin Limit$/ {
    block_active = 1
    delete_block = 0
    block_content = $0 "\n"
    next
  }

  # Inside a block
  block_active {
    block_content = block_content $0 "\n"

    # Check and process HOST line
    if ($1 == "HOST=") {
      split($2, hosts, " ")
      remaining_hosts = ""
      found_host = 0
      host_count = length(hosts)

      # Check for the matching hostname
      for (i in hosts) {
        if (hosts[i] == host) {
          found_host = 1
        } else {
          remaining_hosts = remaining_hosts (remaining_hosts == "" ? "" : " ") hosts[i]
        }
      }

      if (found_host) {
        if (host_count == 1) {
          # If only one hostname exists, mark the block for deletion
          delete_block = 1
        } else {
          # Update the HOST line with remaining hosts
          $0 = "HOST=" remaining_hosts
          updated_block = $0 "\n"
        }
      }
    }
    next
  }

  # End of a block
  /^End Limit$/ {
    if (block_active) {
      if (!delete_block) {
        # If not marked for deletion, print the updated block
        if (updated_block != "") {
          gsub(/HOST=[^\n]+/, updated_block, block_content)  # Replace HOST line
        }
        block_content = block_content $0 "\n"
        print block_content
      }
      # Reset block content
      block_active = 0
      block_content = ""
      updated_block = ""
    }
    next
  }

  # Outside of a block
  {
    print $0
  }
' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

echo "Processing completed. Original file backed up as ${CONFIG_FILE}.bak."
