#!/bin/bash

# Input file
input_file="input.txt"

# Output file
output_file="output.txt"

# Hostname to match
hostname="your_hostname"

awk -v host="$hostname" '
{
    # Store the current line with its line number
    lines[NR] = $0;
}

END {
    blank_above = 0; # Line number of blank line above
    blank_below = 0; # Line number of blank line below
    delete_start = 0;
    delete_end = 0;
    in_block = 0; # Flag to track block status

    for (i = 1; i <= NR; i++) {
        # Track blank line above
        if (lines[i] == "") {
            blank_above = i;
        }

        # Detect the start of a block (Begin limit)
        if (lines[i] == "Begin limit") {
            in_block = 1;
            delete_start = i; # Tentatively mark start of deletion
            next
        }

        # Detect the end of a block (End limit)
        if (lines[i] == "End limit" && in_block) {
            in_block = 0; # Close the block
            delete_end = i; # Tentatively mark end of deletion

            # Determine if the block should be deleted entirely or just specific lines
            block_contains_only_hostname = 1;  # Flag to check if only the matched hostname is present in the block
            block_contains_hostname = 0;       # Flag for when the matched hostname is in the block

            for (j = delete_start + 1; j < delete_end; j++) {
                if (lines[j] ~ host) {
                    block_contains_hostname = 1;
                }
                if (lines[j] !~ host && lines[j] !~ /^[[:space:]]*$/) {
                    block_contains_only_hostname = 0;
                }
            }

            # Delete block entirely if it contains only the matched hostname
            if (block_contains_only_hostname) {
                for (k = delete_start; k <= delete_end; k++) {
                    delete_flag[k] = 1; # Mark for deletion
                }
            } 
            # If block contains other hostnames, delete only matched hostname lines
            else if (block_contains_hostname) {
                for (j = delete_start + 1; j < delete_end; j++) {
                    if (lines[j] ~ host) {
                        delete_flag[j] = 1; # Mark for deletion
                    }
                }
            }
        }

        # Track blank line below the block
        if (lines[i] == "" && delete_end != 0) {
            blank_below = i;
            break; # Break once we find the blank line
        }
    }

    # Output lines not marked for deletion
    for (i = 1; i <= NR; i++) {
        if (!delete_flag[i]) {
            print lines[i];
        }
    }
}
' "$input_file" > "$output_file"

echo "Processed file saved to $output_file."
