#!/bin/bash

# Input file
input_file="input.txt"

# Output file
output_file="output.txt"

# Pattern to match
pattern="your_pattern"

awk -v pat="$pattern" '
{
    # Store the current line with its line number
    lines[NR] = $0;
    line_count = NR; # Total number of lines
}

END {
    blank_above = 0; # Line number of the last blank line above
    blank_below = 0; # Line number of the first blank line below
    delete_start = 0;
    delete_end = 0;

    for (i = 1; i <= line_count; i++) {
        # Mark the most recent blank line above
        if (lines[i] == "") {
            blank_above = i;
        }

        # Check if the line contains the pattern
        if (lines[i] ~ pat) {
            # If the line contains commas, handle it as a multi-entry line
            if (lines[i] ~ /,/) {
                # Split the line by commas
                n = split(lines[i], fields, ",");
                new_line = "";
                for (j = 1; j <= n; j++) {
                    if (fields[j] !~ pat) {
                        new_line = (new_line == "" ? fields[j] : new_line "," fields[j]);
                    }
                }
                # Update the line with the matched pattern removed
                lines[i] = new_line;
            } else {
                # Find the next blank line below
                for (j = i + 1; j <= line_count; j++) {
                    if (lines[j] == "") {
                        blank_below = j;
                        break;
                    }
                }

                # Mark the range for deletion
                delete_start = blank_above + 1; # First line to delete
                delete_end = blank_below - 1;  # Last line to delete
                break; # Stop after processing the first standalone match
            }
        }
    }

    # Print lines that are not in the deletion range
    for (i = 1; i <= line_count; i++) {
        if (i < delete_start || i > delete_end) {
            if (lines[i] != "") { # Print only non-empty lines
                print lines[i];
            }
        }
    }
}
' "$input_file" > "$output_file"

echo "Processed file saved to $output_file."
