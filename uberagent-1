#!/usr/bin/env bash
set -uo pipefail

# install_uberagent_final.sh
# Single-scp copy of installer+conf, install, replace conf, enable/start service.
# - Continues on per-host failures
# - Uses ConnectTimeout for ssh/scp (default 10s)
# - Avoids heredocs inside the while loop

#### CONFIGURATION - edit these ####
HOSTFILE="hosts.txt"               # one host per line
USER="root"                        # remote user
PASS="YourPassword"                # ssh password (consider using SSH keys)
NFS_PATH="/mnt/nfs/uberagent"      # local path where installer + conf exist
REMOTE_TMP="/tmp/uberagent_install"
CONF_PATH="/etc/uberAgent"
LOG="uberagent_install.log"
# Optionally set exact package names. If empty, script auto-detects first .deb/.rpm in NFS_PATH
DEB_NAME=""    # e.g. "uberagent-1.2.3.deb"
RPM_NAME=""    # e.g. "uberagent-7.6.0.1237-1.x86_64.rpm"
CONF_NAME="uberAgent.conf"
SERVICE_NAME="uberAgent.service"

# SSH options
CONNECT_TIMEOUT=10
SSH_OPTIONS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=${CONNECT_TIMEOUT} -o ServerAliveInterval=5 -o ServerAliveCountMax=2"

######################################
echo "===== uberAgent Installation Started: $(date -u) =====" | tee -a "$LOG"

# Auto-detect installer filenames from NFS if variables are empty
if [[ -z "$DEB_NAME" ]]; then
  DEB_NAME=$(ls -1 "$NFS_PATH"/*.deb 2>/dev/null | head -n1 || true)
  [[ -n "$DEB_NAME" ]] && DEB_NAME=$(basename "$DEB_NAME")
fi
if [[ -z "$RPM_NAME" ]]; then
  RPM_NAME=$(ls -1 "$NFS_PATH"/*.rpm 2>/dev/null | head -n1 || true)
  [[ -n "$RPM_NAME" ]] && RPM_NAME=$(basename "$RPM_NAME")
fi

echo "Using DEB_NAME='${DEB_NAME:-<none>}' RPM_NAME='${RPM_NAME:-<none>}'" | tee -a "$LOG"
echo "CONF_NAME='$CONF_NAME' SERVICE_NAME='$SERVICE_NAME' SSH_TIMEOUT=${CONNECT_TIMEOUT}s" | tee -a "$LOG"

# Basic local checks
if [[ ! -f "$NFS_PATH/$CONF_NAME" ]]; then
  echo "ERROR: Config missing at $NFS_PATH/$CONF_NAME - aborting" | tee -a "$LOG"
  exit 1
fi
if [[ -z "$DEB_NAME" && -z "$RPM_NAME" ]]; then
  echo "ERROR: No installer (.deb or .rpm) found in $NFS_PATH - aborting" | tee -a "$LOG"
  exit 1
fi

# Helper to run ssh commands (returns status)
run_ssh() {
  local host="$1"; shift
  sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "$@"
}

# read and process hosts
while IFS= read -r raw_host || [[ -n "$raw_host" ]]; do
  host=$(echo "$raw_host" | xargs)   # trim whitespace
  [[ -z "$host" || "$host" =~ ^# ]] && continue

  echo "---- Processing $host ----" | tee -a "$LOG"

  # Create remote temp dir (skip host if cannot connect)
  if ! sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "mkdir -p '$REMOTE_TMP' >/dev/null 2>&1"; then
    echo "❌ $host: cannot connect/create remote tmp (skipping)." | tee -a "$LOG"
    continue
  fi

  # Detect remote OS (best-effort)
  OS_TYPE=$(sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "awk -F= '/^ID=/{gsub(/\"/,\"\",\$2); print \$2; exit}' /etc/os-release 2>/dev/null || echo unknown" 2>/dev/null || echo unknown)
  OS_TYPE=${OS_TYPE,,}
  echo "$host OS detected: ${OS_TYPE:-unknown}" | tee -a "$LOG"

  # Choose installer local path based on OS
  if [[ "$OS_TYPE" == "debian" || "$OS_TYPE" == "ubuntu" ]]; then
    if [[ -z "$DEB_NAME" ]]; then
      echo "❌ $host: no deb installer available (skipping)" | tee -a "$LOG"
      continue
    fi
    INSTALLER_LOCAL="$NFS_PATH/$DEB_NAME"
  else
    if [[ -z "$RPM_NAME" ]]; then
      echo "❌ $host: no rpm installer available (skipping)" | tee -a "$LOG"
      continue
    fi
    INSTALLER_LOCAL="$NFS_PATH/$RPM_NAME"
  fi

  # Local existence check
  if [[ ! -f "$INSTALLER_LOCAL" ]]; then
    echo "❌ $host: local installer missing: $INSTALLER_LOCAL (skipping)" | tee -a "$LOG"
    continue
  fi

  # Copy both installer + conf in single scp call
  echo "$host: copying installer + config to $REMOTE_TMP" | tee -a "$LOG"
  if ! sshpass -p "$PASS" scp $SSH_OPTIONS "$INSTALLER_LOCAL" "$NFS_PATH/$CONF_NAME" "$USER@$host:$REMOTE_TMP/"; then
    echo "❌ $host: scp failed (skipping)" | tee -a "$LOG"
    continue
  fi

  # Remote detect exact installer path (avoid quoting substitution issues)
  REMOTE_CHECK_CMD="ls -1 '$REMOTE_TMP'/*.rpm '$REMOTE_TMP'/*.deb 2>/dev/null | head -n1 || true"
  REMOTE_INSTALLER_PATH=$(sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "$REMOTE_CHECK_CMD")
  if [[ -z "$REMOTE_INSTALLER_PATH" ]]; then
    echo "❌ $host: no installer found in $REMOTE_TMP after scp. Remote listing:" | tee -a "$LOG"
    sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "ls -la '$REMOTE_TMP' || true" 2>&1 | tee -a "$LOG"
    continue
  fi

  echo "$host: detected remote installer -> $REMOTE_INSTALLER_PATH" | tee -a "$LOG"

  # Install using detected remote path
  echo "$host: installing package $REMOTE_INSTALLER_PATH" | tee -a "$LOG"
  if [[ "$REMOTE_INSTALLER_PATH" == *.deb ]]; then
    if ! sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "dpkg -i '$REMOTE_INSTALLER_PATH' || (apt-get update -y && apt-get install -f -y)"; then
      echo "❌ $host: deb install failed (continuing to next host)" | tee -a "$LOG"
      continue
    fi
  else
    if ! sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "if command -v dnf >/dev/null 2>&1; then dnf install -y '$REMOTE_INSTALLER_PATH'; else yum install -y '$REMOTE_INSTALLER_PATH'; fi"; then
      echo "❌ $host: rpm install failed (continuing to next host)" | tee -a "$LOG"
      continue
    fi
  fi

  # Replace configuration (backup previous) - using inline ssh commands (no heredoc)
  echo "$host: updating configuration at $CONF_PATH" | tee -a "$LOG"
  sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "
    set -e
    mkdir -p '$CONF_PATH' || true
    if [ -f '$CONF_PATH/$CONF_NAME' ]; then
      cp -p '$CONF_PATH/$CONF_NAME' '$CONF_PATH/${CONF_NAME}.bak.$(date +%s)' || true
    fi
    cp -p '$REMOTE_TMP/$CONF_NAME' '$CONF_PATH/$CONF_NAME' || true
    chown root:root '$CONF_PATH/$CONF_NAME' || true
    chmod 0644 '$CONF_PATH/$CONF_NAME' || true
  " 2>&1 | tee -a "$LOG"

  # Enable + start service (simple commands)
  echo "$host: enabling + starting $SERVICE_NAME" | tee -a "$LOG"
  sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "
    systemctl daemon-reload || true
    systemctl enable '$SERVICE_NAME' || true
    systemctl start '$SERVICE_NAME' || true
    systemctl status --no-pager '$SERVICE_NAME' --lines=10 || true
  " 2>&1 | tee -a "$LOG"

  # cleanup remote tmp directory
  sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "rm -rf '$REMOTE_TMP' || true" 2>/dev/null || true

  echo "✔ $host: completed" | tee -a "$LOG"
done < "$HOSTFILE"

echo "===== uberAgent Installation Completed: $(date -u) =====" | tee -a "$LOG"
