#!/usr/bin/env bash
# install_uberagent_timeout.sh
# Single-scp copy of installer+conf, install, replace conf, enable/start service.
# - Continues on per-host failures (doesn't exit whole script)
# - Uses SSH/SCP ConnectTimeout=10 by default (skip if host not reachable)
# - Auto-detects installer filename from NFS unless you set DEB_NAME/RPM_NAME

#### Configuration (edit these) ####
HOSTFILE="hosts.txt"                # one host per line
USER="root"
PASS="YourPassword"                 # consider SSH keys instead of passwords
NFS_PATH="/mnt/nfs/uberagent"       # local NFS directory containing installer and conf
REMOTE_TMP="/tmp/uberagent_install"
CONF_PATH="/etc/uberAgent"
LOG="uberagent_install.log"
# Optionally set exact package names. If empty, script auto-detects first .deb/.rpm in NFS_PATH
DEB_NAME=""   # e.g. "uberagent-1.2.3.deb"
RPM_NAME=""   # e.g. "uberagent-7.6.0.1237-1.x86_64.rpm"
CONF_NAME="uberAgent.conf"
SERVICE_NAME="uberAgent.service"

# SSH options: connect timeout 10s (change if needed)
SSH_OPTIONS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=2"

echo "===== uberAgent Installation Started: $(date -u) =====" | tee -a "$LOG"

# auto-detect package filenames from NFS if variables are empty
if [[ -z "$DEB_NAME" ]]; then
  DEB_NAME=$(ls -1 "$NFS_PATH"/*.deb 2>/dev/null | head -n1 || true)
  [[ -n "$DEB_NAME" ]] && DEB_NAME=$(basename "$DEB_NAME")
fi
if [[ -z "$RPM_NAME" ]]; then
  RPM_NAME=$(ls -1 "$NFS_PATH"/*.rpm 2>/dev/null | head -n1 || true)
  [[ -n "$RPM_NAME" ]] && RPM_NAME=$(basename "$RPM_NAME")
fi

echo "Using DEB_NAME='${DEB_NAME:-<none>}' RPM_NAME='${RPM_NAME:-<none>}'" | tee -a "$LOG"
echo "Using CONF_NAME='$CONF_NAME' SERVICE_NAME='$SERVICE_NAME'" | tee -a "$LOG"

# basic checks
if [[ ! -f "$NFS_PATH/$CONF_NAME" ]]; then
  echo "ERROR: Config missing at $NFS_PATH/$CONF_NAME - aborting" | tee -a "$LOG"
  exit 1
fi
if [[ -z "$DEB_NAME" && -z "$RPM_NAME" ]]; then
  echo "ERROR: No installer (.deb or .rpm) found in $NFS_PATH - aborting" | tee -a "$LOG"
  exit 1
fi

# read hosts
while IFS= read -r host || [[ -n "$host" ]]; do
  host=$(echo "$host" | xargs)   # trim
  [[ -z "$host" || "$host" =~ ^# ]] && continue

  echo "---- Processing $host ----" | tee -a "$LOG"

  # make remote temp dir (skip if cannot connect within connect timeout)
  if ! sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "mkdir -p '$REMOTE_TMP'"; then
    echo "❌ $host: cannot connect/create remote tmp (skipping)." | tee -a "$LOG"
    continue
  fi

  # detect remote OS (best-effort)
  OS_TYPE=$(sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "awk -F= '/^ID=/{gsub(/\"/,\"\",\$2); print \$2; exit}' /etc/os-release 2>/dev/null || echo unknown" 2>/dev/null || echo unknown)
  OS_TYPE=${OS_TYPE,,}
  echo "$host OS detected: ${OS_TYPE:-unknown}" | tee -a "$LOG"

  # choose which local installer to copy based on OS (if both exist, pick one)
  if [[ "$OS_TYPE" == "debian" || "$OS_TYPE" == "ubuntu" ]]; then
    if [[ -z "$DEB_NAME" ]]; then
      echo "❌ $host: no deb installer available to install on Debian/Ubuntu. Skipping." | tee -a "$LOG"
      continue
    fi
    INSTALLER_LOCAL="$NFS_PATH/$DEB_NAME"
    INSTALLER_BASENAME="$DEB_NAME"
  else
    # treat others as rpm-based
    if [[ -z "$RPM_NAME" ]]; then
      echo "❌ $host: no rpm installer available to install on RPM-based host. Skipping." | tee -a "$LOG"
      continue
    fi
    INSTALLER_LOCAL="$NFS_PATH/$RPM_NAME"
    INSTALLER_BASENAME="$RPM_NAME"
  fi

  # final file existence check locally
  if [[ ! -f "$INSTALLER_LOCAL" ]]; then
    echo "❌ $host: expected installer missing locally: $INSTALLER_LOCAL (skipping)" | tee -a "$LOG"
    continue
  fi

  # Copy installer + conf in single scp (with same ssh connect timeout)
  echo "$host: copying $INSTALLER_BASENAME and $CONF_NAME to $REMOTE_TMP" | tee -a "$LOG"
  if ! sshpass -p "$PASS" scp $SSH_OPTIONS "$INSTALLER_LOCAL" "$NFS_PATH/$CONF_NAME" "$USER@$host:$REMOTE_TMP/"; then
    echo "❌ $host: scp failed (skipping)" | tee -a "$LOG"
    continue
  fi

  # Verify on remote which installer was copied (remote-side detection to avoid quoting issues)
  REMOTE_CHECK_CMD="ls -1 '$REMOTE_TMP'/*.rpm '$REMOTE_TMP'/*.deb 2>/dev/null | head -n1 || true"
  REMOTE_INSTALLER_PATH=$(sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "$REMOTE_CHECK_CMD")
  if [[ -z "$REMOTE_INSTALLER_PATH" ]]; then
    echo "❌ $host: no installer found in $REMOTE_TMP after scp. Remote listing:" | tee -a "$LOG"
    sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "ls -la '$REMOTE_TMP' || true" 2>&1 | tee -a "$LOG"
    continue
  fi

  echo "$host: detected remote installer -> $REMOTE_INSTALLER_PATH" | tee -a "$LOG"

  # Install using detected remote path
  echo "$host: installing package $REMOTE_INSTALLER_PATH" | tee -a "$LOG"
  if [[ "$REMOTE_INSTALLER_PATH" == *.deb ]]; then
    if ! sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "dpkg -i '$REMOTE_INSTALLER_PATH' || (apt-get update -y && apt-get install -f -y)"; then
      echo "❌ $host: deb install failed (continuing to next host)" | tee -a "$LOG"
      # show dpkg/apt related logs
      sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "journalctl -u dpkg -n 50 2>/dev/null || true" 2>&1 | tee -a "$LOG" || true
    fi
  else
    if ! sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "if command -v dnf >/dev/null 2>&1; then dnf install -y '$REMOTE_INSTALLER_PATH'; else yum install -y '$REMOTE_INSTALLER_PATH'; fi"; then
      echo "❌ $host: rpm install failed (continuing to next host)" | tee -a "$LOG"
    fi
  fi

  # Replace configuration (backup previous)
  echo "$host: updating configuration at $CONF_PATH" | tee -a "$LOG"
  sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" bash -s <<'REMOTE' 2>/dev/null || true
set -e
REMOTE_TMP="/tmp/uberagent_install"
CONF_PATH="/etc/uberAgent"
CONF_NAME="uberAgent.conf"
mkdir -p "$CONF_PATH"
if [[ -f "$CONF_PATH/$CONF_NAME" ]]; then
  cp -p "$CONF_PATH/$CONF_NAME" "$CONF_PATH/${CONF_NAME}.bak.$(date +%s)" || true
fi
cp -p "$REMOTE_TMP/$CONF_NAME" "$CONF_PATH/$CONF_NAME" || true
chown root:root "$CONF_PATH/$CONF_NAME" || true
chmod 0644 "$CONF_PATH/$CONF_NAME" || true
REMOTE

  # Enable + start service (simple fixed commands)
  echo "$host: enabling + starting $SERVICE_NAME" | tee -a "$LOG"
  sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "
    systemctl daemon-reload || true
    systemctl enable '$SERVICE_NAME' || true
    systemctl start '$SERVICE_NAME' || true
    systemctl status --no-pager '$SERVICE_NAME' --lines=10 || true
  " 2>&1 | tee -a "$LOG" || true

  # cleanup remote tmp
  sshpass -p "$PASS" ssh $SSH_OPTIONS "$USER@$host" "rm -rf '$REMOTE_TMP' || true" 2>/dev/null || true

  echo "✔ $host: completed" | tee -a "$LOG"
done < "$HOSTFILE"

echo "===== uberAgent Installation Completed: $(date -u) =====" | tee -a "$LOG"
