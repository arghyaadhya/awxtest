#!/bin/bash

# Input validation
if [[ $# -ne 2 ]]; then
  echo "Usage: $0 <file> <string_to_match>"
  exit 1
fi

file="$1"
string="$2"

# Check if file exists
if [[ ! -f "$file" ]]; then
  echo "Error: File not found!"
  exit 1
fi

# Use a temporary file for processing
temp_file=$(mktemp)

awk -v search="$string" '
{
  lines[NR] = $0
  if ($0 == search) { 
    full_match_lines[NR] = 1 
  } else if ($0 ~ "\\b" search "\\b") { 
    partial_match_lines[NR] = 1 
  }
}

END {
  # Handle full matches: delete surrounding blank-line-separated block
  for (line_no in full_match_lines) {
    start = end = line_no
    # Find blank line above
    while (start > 1 && lines[start - 1] != "") start--
    # Find blank line below
    while (end < NR && lines[end + 1] != "") end++
    # Mark lines for deletion
    for (j = start; j <= end; j++) to_delete[j] = 1
  }

  # Handle partial matches: remove only the string from the lines
  for (line_no in partial_match_lines) {
    # Remove the exact match from the line
    lines[line_no] = gensub("\\b" search "\\b", "", "g", lines[line_no])
    # Trim leading and trailing spaces
    lines[line_no] = gensub("^ +| +$", "", "g", lines[line_no])
    # If the entire line becomes empty after removal, mark it for deletion
    if (lines[line_no] == "") to_delete[line_no] = 1
  }

  # Print updated lines
  for (k = 1; k <= NR; k++) {
    if (!to_delete[k]) print lines[k]
  }
}
' "$file" > "$temp_file"

# Replace the original file
mv "$temp_file" "$file"

echo "Processing completed. Check $file."
